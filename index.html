<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Mood â†’ Spotify</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .sub-title {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 20px 24px;
      box-shadow: 0 18px 30px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }

    .status {
      font-size: 12px;
      color: #9ca3af;
    }

    .status span {
      font-weight: 600;
    }

    .login-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #22c55e;
      background: transparent;
      color: #bbf7d0;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .login-btn:hover {
      background: #022c22;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px 24px;
      margin-bottom: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 14px;
      color: #cbd5f5;
    }

    select,
    input[type="range"],
    button {
      font: inherit;
    }

    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }

    select:focus {
      border-color: #38bdf8;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }

    .checkbox-item input {
      accent-color: #38bdf8;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-value {
      min-width: 40px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #f9fafb;
    }

    input[type="range"] {
      width: 100%;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }

    button#generateBtn {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button#generateBtn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    button#generateBtn:active {
      transform: translateY(0);
      filter: brightness(0.98);
    }

    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }

    .error {
      margin-top: 8px;
      font-size: 13px;
      color: #fecaca;
    }

    .results-wrapper {
      margin-top: 28px;
    }

    .results-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #e5e7eb;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .playlist-card {
      background: #020617;
      border-radius: 14px;
      padding: 14px 14px 16px;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .playlist-cover {
      width: 100%;
      border-radius: 10px;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      background: #111827;
    }

    .playlist-title {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }

    .playlist-meta {
      font-size: 12px;
      color: #9ca3af;
    }

    .playlist-link {
      margin-top: 6px;
      font-size: 13px;
      text-decoration: none;
      color: #38bdf8;
      align-self: flex-start;
    }

    .playlist-link:hover {
      text-decoration: underline;
    }

    .empty-state {
      font-size: 13px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Mood â†’ Spotify</h1>
    <div class="sub-title">ç™»å…¥ Spotify å¾Œï¼Œæ ¹æ“šå¿ƒæƒ…å¹«ä½ æ‰¾æ’­æ”¾æ¸…å–® ğŸ§</div>

    <div class="card">
      <div class="card-header">
        <div class="status" id="statusText">
          Spotify ç‹€æ…‹ï¼š<span>å°šæœªç™»å…¥</span>
        </div>
        <button type="button" class="login-btn" id="loginBtn">
          Login with Spotify
          <span>ğŸŸ¢</span>
        </button>
      </div>

      <form id="moodForm">
        <div class="form-grid">
          <!-- æƒ…ç·’ -->
          <div class="field">
            <label for="mood">æƒ…ç·’</label>
            <select id="mood" name="mood" required>
              <option value="é–‹å¿ƒ">é–‹å¿ƒ</option>
              <option value="æ”¾ç©º">æ”¾ç©º</option>
              <option value="å¾ˆç´¯">å¾ˆç´¯</option>
              <option value="æƒ³å“­">æƒ³å“­</option>
              <option value="æƒ³è¡åˆºè®€æ›¸">æƒ³è¡åˆºè®€æ›¸</option>
              <option value="æƒ³é‹å‹•">æƒ³é‹å‹•</option>
              <option value="æƒ³è€å»¢">æƒ³è€å»¢</option>
            </select>
          </div>

          <!-- é¢¨æ ¼ -->
          <div class="field">
            <label>é¢¨æ ¼ï¼ˆå¯è¤‡é¸ï¼‰</label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="lofi" /> lofi
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="jazz" /> jazz
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="classical" /> classical
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="indie" /> indie
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="R&B" /> R&amp;B
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="rock" /> rock
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="K-pop" /> K-pop
              </label>
            </div>
          </div>

          <!-- å ´æ™¯ -->
          <div class="field">
            <label for="scene">å ´æ™¯</label>
            <select id="scene" name="scene" required>
              <option value="è®€æ›¸">è®€æ›¸</option>
              <option value="å·¥ä½œ">å·¥ä½œ</option>
              <option value="é€šå‹¤">é€šå‹¤</option>
              <option value="ç¡å‰">ç¡å‰</option>
              <option value="é‹å‹•">é‹å‹•</option>
              <option value="å¤±æˆ€">å¤±æˆ€</option>
            </select>
          </div>

          <!-- èƒ½é‡ -->
          <div class="field">
            <label for="energy">èƒ½é‡ï¼ˆ0â€“100ï¼‰</label>
            <div class="slider-row">
              <input
                type="range"
                id="energy"
                name="energy"
                min="0"
                max="100"
                value="50"
              />
              <span class="slider-value" id="energyValue">50</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" id="generateBtn">
            å¹«æˆ‘æ‰¾æ­Œå–®
            <span>ğŸ§</span>
          </button>
        </div>

        <div class="hint">
          1ï¸âƒ£ å…ˆæŒ‰å³ä¸Šè§’ã€ŒLogin with Spotifyã€æˆæ¬Š<br />
          2ï¸âƒ£ é¸å¥½å¿ƒæƒ…èˆ‡é¢¨æ ¼å¾ŒæŒ‰ã€Œå¹«æˆ‘æ‰¾æ­Œå–®ã€ï¼ŒæœƒçœŸçš„å‘¼å« Spotify Search APIã€‚
        </div>
        <div id="error" class="error"></div>
      </form>
    </div>

    <div class="results-wrapper">
      <div class="results-title">æ¨è–¦æ­Œå–®</div>
      <div id="results" class="results-grid">
        <div class="empty-state">é‚„æ²’æœ‰æ­Œå–®ï¼Œå…ˆç™»å…¥ Spotify å†é¸å¿ƒæƒ…å§ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // ==========================
      // ğŸ” Spotify è¨­å®šå€ï¼ˆä½ è¦æ”¹çš„åœ°æ–¹ï¼‰
      // ==========================

      // 1ï¸âƒ£ Spotify Client IDï¼šåˆ° https://developer.spotify.com å»º App å¾Œå–å¾—
      const CLIENT_ID = "YOUR_SPOTIFY_CLIENT_ID"; // â† åœ¨é€™è£¡å¡«ä¸Šä½ çš„ Client ID

      // 2ï¸âƒ£ Redirect URIï¼šå¿…é ˆå’Œ Spotify å¾Œå°è¨­å®šçš„ä¸€æ¨¡ä¸€æ¨£
      //    ä¾‹å¦‚ï¼š "http://localhost:5500/mood-spotify.html"
      const REDIRECT_URI = "YOUR_REDIRECT_URI"; // â† åœ¨é€™è£¡å¡«ä¸Šä½ çš„ Redirect URI

      const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
      const RESPONSE_TYPE = "token"; // ä½¿ç”¨ Implicit Grant Flow

      // ==========================
      // å…¨åŸŸç‹€æ…‹
      // ==========================
      let accessToken = null;
      let tokenExpiresAt = null;

      const energyInput = document.getElementById("energy");
      const energyValueSpan = document.getElementById("energyValue");
      const form = document.getElementById("moodForm");
      const results = document.getElementById("results");
      const errorBox = document.getElementById("error");
      const statusText = document.getElementById("statusText");
      const loginBtn = document.getElementById("loginBtn");

      // ==========================
      // å·¥å…·ï¼šè™•ç† URL hash æ‹¿ token
      // ==========================
      function parseHash() {
        // ç•¶ Spotify redirect å›ä¾†æ™‚ï¼ŒURL æœƒåƒï¼š
        // http://your-redirect-uri#access_token=xxx&token_type=Bearer&expires_in=3600
        if (!window.location.hash) return;

        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get("access_token");
        const expiresIn = params.get("expires_in");

        if (token) {
          const expiresAt = Date.now() + Number(expiresIn) * 1000;

          // å­˜åœ¨ localStorageï¼Œè®“é‡æ–°æ•´ç†å¾Œé‚„èƒ½ç”¨
          localStorage.setItem("spotify_access_token", token);
          localStorage.setItem("spotify_expires_at", String(expiresAt));

          accessToken = token;
          tokenExpiresAt = expiresAt;

          // æ¸…æ‰ hashï¼ŒURL æ¯”è¼ƒä¹¾æ·¨
          window.location.hash = "";
        }
      }

      function loadTokenFromStorage() {
        const token = localStorage.getItem("spotify_access_token");
        const expiresAtStr = localStorage.getItem("spotify_expires_at");

        if (!token || !expiresAtStr) return;

        const expiresAt = Number(expiresAtStr);
        if (Date.now() > expiresAt) {
          // éæœŸå°±æ¸…æ‰
          localStorage.removeItem("spotify_access_token");
          localStorage.removeItem("spotify_expires_at");
          return;
        }

        accessToken = token;
        tokenExpiresAt = expiresAt;
      }

      function updateStatusUI() {
        if (accessToken && tokenExpiresAt && Date.now() < tokenExpiresAt) {
          const remainingSec = Math.floor((tokenExpiresAt - Date.now()) / 1000);
          const min = Math.floor(remainingSec / 60);
          const sec = remainingSec % 60;
          statusText.innerHTML =
            'Spotify ç‹€æ…‹ï¼š<span>å·²ç™»å…¥</span>ï¼ˆç´„ ' +
            min +
            " åˆ† " +
            sec +
            " ç§’å¾ŒéæœŸï¼‰";
        } else {
          statusText.innerHTML = 'Spotify ç‹€æ…‹ï¼š<span>å°šæœªç™»å…¥</span>';
        }
      }

      // ==========================
      // Login æŒ‰éˆ• â†’ å‰å¾€ Spotify æˆæ¬Š
      // ==========================
      loginBtn.addEventListener("click", function () {
        errorBox.textContent = "";

        const scopes = [
          "playlist-read-private",
          "playlist-read-collaborative",
        ];

        const authUrl =
          AUTH_ENDPOINT +
          "?client_id=" +
          encodeURIComponent(CLIENT_ID) +
          "&redirect_uri=" +
          encodeURIComponent(REDIRECT_URI) +
          "&response_type=" +
          encodeURIComponent(RESPONSE_TYPE) +
          "&scope=" +
          encodeURIComponent(scopes.join(" "));

        // å°å‘ Spotify æˆæ¬Šé é¢
        window.location = authUrl;
      });

      // ==========================
      // èƒ½é‡æ»‘æ¡¿ UI
      // ==========================
      energyInput.addEventListener("input", function () {
        energyValueSpan.textContent = energyInput.value;
      });

      // ==========================
      // æŠŠä½¿ç”¨è€…é¸æ“‡çš„ Mood â†’ çµ„æˆæœå°‹é—œéµå­—
      // ==========================
      function buildSearchQuery(selection) {
        const { mood, styles, scene, energy } = selection;

        const moodMap = {
          é–‹å¿ƒ: "happy",
          æ”¾ç©º: "chill",
          å¾ˆç´¯: "tired calm",
          æƒ³å“­: "sad emotional",
          æƒ³è¡åˆºè®€æ›¸: "focus study",
          æƒ³é‹å‹•: "workout",
          æƒ³è€å»¢: "lazy chill",
        };

        const sceneMap = {
          è®€æ›¸: "study",
          å·¥ä½œ: "work focus",
          é€šå‹¤: "commute",
          ç¡å‰: "sleep",
          é‹å‹•: "gym running",
          å¤±æˆ€: "heartbreak",
        };

        let energyWords = "";
        if (energy <= 30) {
          energyWords = "soft low energy";
        } else if (energy <= 70) {
          energyWords = "medium energy";
        } else {
          energyWords = "high energy";
        }

        const moodWords = moodMap[mood] || "";
        const sceneWords = sceneMap[scene] || "";

        const stylesWords =
          styles.length > 0 ? styles.join(" ") : "spotify playlist";

        // æœ€å¾Œçµ„åˆæˆä¸€é•·ä¸² query çµ¦ Spotify Search ç”¨
        const query = [stylesWords, moodWords, sceneWords, energyWords]
          .filter(Boolean)
          .join(" ");

        return query.trim();
      }

      // ==========================
      // å‘¼å« Spotify Search API
      // ==========================
      async function searchPlaylists(selection) {
        if (!accessToken || (tokenExpiresAt && Date.now() > tokenExpiresAt)) {
          throw new Error("NO_TOKEN");
        }

        const query = buildSearchQuery(selection);
        const url =
          "https://api.spotify.com/v1/search?q=" +
          encodeURIComponent(query) +
          "&type=playlist&limit=9";

        const res = await fetch(url, {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        });

        if (!res.ok) {
          let message = "Spotify API å›å‚³éŒ¯èª¤ï¼ˆç‹€æ…‹ç¢¼ " + res.status + "ï¼‰";
          try {
            const data = await res.json();
            if (data && data.error && data.error.message) {
              message += "ï¼š" + data.error.message;
            }
          } catch (e) {
            // ignore parse error
          }
          throw new Error(message);
        }

        const data = await res.json();
        return data.playlists.items || [];
      }

      // ==========================
      // å°‡ playlist é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
      // ==========================
      function renderPlaylists(playlists, selection) {
        results.innerHTML = "";

        if (!playlists.length) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent =
            "æ‰¾ä¸åˆ°ç¬¦åˆé€™å€‹å¿ƒæƒ…çš„æ­Œå–®ï¼Œå¯ä»¥è©¦è©¦çœ‹æ›å€‹é¢¨æ ¼æˆ–èª¿æ•´èƒ½é‡ã€‚";
          results.appendChild(div);
          return;
        }

        playlists.forEach((pl) => {
          const card = document.createElement("div");
          card.className = "playlist-card";

          const img = document.createElement("img");
          img.className = "playlist-cover";
          img.src =
            (pl.images && pl.images[0] && pl.images[0].url) ||
            "https://via.placeholder.com/300?text=Playlist";
          img.alt = pl.name || "Playlist cover";

          const title = document.createElement("div");
          title.className = "playlist-title";
          title.textContent = pl.name || "Untitled playlist";

          const meta = document.createElement("div");
          meta.className = "playlist-meta";
          meta.textContent =
            "by " +
            (pl.owner && pl.owner.display_name
              ? pl.owner.display_name
              : "unknown") +
            " Â· å…± " +
            (pl.tracks && pl.tracks.total ? pl.tracks.total : "?") +
            " é¦–æ­Œ";

          const link = document.createElement("a");
          link.className = "playlist-link";
          link.href = pl.external_urls ? pl.external_urls.spotify : "#";
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "åœ¨ Spotify é–‹å•Ÿ";

          card.appendChild(img);
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(link);

          results.appendChild(card);
        });
      }

      // ==========================
      // è¡¨å–®é€å‡ºï¼šçµ„ selection â†’ call Spotify
      // ==========================
      form.addEventListener("submit", async function (event) {
        event.preventDefault();
        errorBox.textContent = "";

        const mood = document.getElementById("mood").value;
        const scene = document.getElementById("scene").value;
        const energy = parseInt(document.getElementById("energy").value, 10);
        const styles = Array.from(
          document.querySelectorAll('input[name="styles"]:checked')
        ).map((input) => input.value);

        const selection = {
          mood,
          styles,
          scene,
          energy,
        };

        console.log("ä½¿ç”¨è€…é¸æ“‡ï¼š", selection);

        if (!accessToken || (tokenExpiresAt && Date.now() > tokenExpiresAt)) {
          errorBox.textContent = "å°šæœªç™»å…¥ Spotify æˆ– token å·²éæœŸï¼Œè«‹å…ˆæŒ‰å³ä¸Šè§’ Loginã€‚";
          return;
        }

        // å…ˆé¡¯ç¤º loading ç‹€æ…‹
        results.innerHTML =
          '<div class="empty-state">æ­£åœ¨å¹«ä½ æ‰¾æ­Œå–®ï¼Œç¨ç­‰ä¸€ä¸‹...</div>';

        try {
          const playlists = await searchPlaylists(selection);
          renderPlaylists(playlists, selection);
        } catch (err) {
          console.error(err);
          if (err.message === "NO_TOKEN") {
            errorBox.textContent =
              "å°šæœªç™»å…¥ Spotifyï¼Œè«‹å…ˆæŒ‰å³ä¸Šè§’ Login with Spotifyã€‚";
          } else {
            errorBox.textContent = "å‘¼å« Spotify API æ™‚å‡ºéŒ¯ï¼š" + err.message;
          }
          results.innerHTML =
            '<div class="empty-state">æš«æ™‚ç„¡æ³•å–å¾—æ­Œå–®ã€‚</div>';
        }

        updateStatusUI();
      });

      // ==========================
      // åˆå§‹åŒ–ï¼šè¼‰å…¥ tokenã€è™•ç† hash
      // ==========================
      parseHash();
      loadTokenFromStorage();
      updateStatusUI();
    })();
  </script>
</body>
</html>
