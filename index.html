<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Mood â†’ Spotify</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 8px;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .login-area {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #bbf7d0;
    }
    #spotifyStatus {
      font-size: 13px;
      color: #9ca3af;
    }
    #loginBtn {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #1db954;
      color: #022c22;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
    }
    #loginBtn:hover {
      filter: brightness(1.05);
      transform: translateY(-0.5px);
    }
    #loginBtn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 16px;
      padding: 20px 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(14px);
    }
    .sub-title {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px 24px;
      margin-bottom: 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    label {
      font-size: 13px;
      color: #cbd5f5;
    }
    select, input[type="range"], button {
      font: inherit;
    }
    select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    select:focus {
      border-color: #38bdf8;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .checkbox-item input {
      accent-color: #38bdf8;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .slider-value {
      min-width: 40px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #f9fafb;
      font-size: 13px;
    }
    input[type="range"] {
      width: 100%;
    }
    .actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }
    #generateBtn {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    #generateBtn:hover {
      filter: brightness(1.05);
      transform: translateY(-0.5px);
    }
    #generateBtn:active {
      transform: translateY(0);
      filter: brightness(0.96);
    }
    #errorBox {
      margin-top: 8px;
      font-size: 12px;
      color: #fecaca;
      min-height: 18px;
    }
    #playlistsSection {
      margin-top: 22px;
    }
    #playlistsTitle {
      font-size: 15px;
      margin-bottom: 10px;
      color: #e5e7eb;
    }
    .playlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }
    .playlist-card {
      background: #020617;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(75, 85, 99, 0.7);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .playlist-card img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .playlist-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .playlist-name {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .playlist-owner {
      font-size: 12px;
      color: #9ca3af;
    }
    .playlist-link {
      margin-top: 4px;
      font-size: 12px;
    }
    .playlist-link a {
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #22c55e;
      color: #bbf7d0;
      font-size: 11px;
    }
    .playlist-link a:hover {
      background: #22c55e;
      color: #022c22;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>Mood â†’ Spotify</h1>
        <div class="sub-title">ç”¨æƒ…ç·’ + é¢¨æ ¼é¸æ­Œå–®ï¼ˆé€™ç‰ˆçœŸçš„æœ‰å‘¼å« Spotify Web APIï¼‰</div>
      </div>
      <div class="login-area">
        <span class="badge">Spotify Web API</span>
        <span id="spotifyStatus">å°šæœªç™»å…¥</span>
        <button id="loginBtn" type="button">
          Login with Spotify
        </button>
      </div>
    </header>

    <div class="card">
      <form id="moodForm">
        <div class="form-grid">
          <div class="field">
            <label for="mood">æƒ…ç·’</label>
            <select id="mood" name="mood" required>
              <option value="é–‹å¿ƒ">é–‹å¿ƒ</option>
              <option value="æ”¾ç©º">æ”¾ç©º</option>
              <option value="å¾ˆç´¯">å¾ˆç´¯</option>
              <option value="æƒ³å“­">æƒ³å“­</option>
              <option value="æƒ³è¡åˆºè®€æ›¸">æƒ³è¡åˆºè®€æ›¸</option>
              <option value="æƒ³é‹å‹•">æƒ³é‹å‹•</option>
              <option value="æƒ³è€å»¢">æƒ³è€å»¢</option>
            </select>
          </div>

          <div class="field">
            <label>é¢¨æ ¼ï¼ˆå¯è¤‡é¸ï¼‰</label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="lofi" /> lofi
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="jazz" /> jazz
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="classical" /> classical
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="indie" /> indie
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="R&B" /> R&amp;B
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="rock" /> rock
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="styles" value="K-pop" /> K-pop
              </label>
            </div>
          </div>

          <div class="field">
            <label for="scene">å ´æ™¯</label>
            <select id="scene" name="scene" required>
              <option value="è®€æ›¸">è®€æ›¸</option>
              <option value="å·¥ä½œ">å·¥ä½œ</option>
              <option value="é€šå‹¤">é€šå‹¤</option>
              <option value="ç¡å‰">ç¡å‰</option>
              <option value="é‹å‹•">é‹å‹•</option>
              <option value="å¤±æˆ€">å¤±æˆ€</option>
            </select>
          </div>

          <div class="field">
            <label for="energy">èƒ½é‡ï¼ˆ0â€“100ï¼‰</label>
            <div class="slider-row">
              <input
                type="range"
                id="energy"
                name="energy"
                min="0"
                max="100"
                value="50"
              />
              <span class="slider-value" id="energyValue">50</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" id="generateBtn">
            å¹«æˆ‘æ‰¾æ­Œå–® ğŸ§
          </button>
        </div>

        <div id="errorBox"></div>
      </form>

      <section id="playlistsSection" style="display:none;">
        <div id="playlistsTitle">ç‚ºä½ æ‰¾åˆ°çš„æ­Œå–®ï¼š</div>
        <div id="playlistsContainer" class="playlist-grid"></div>
      </section>
    </div>
  </div>

  <script>
    // ====== Spotify OAuth è¨­å®š ======
    const CLIENT_ID = "0b26f1d7c1a444ee9d12b89050936c0c";
    const REDIRECT_URI = "https://michelle05102800-gif.github.io/mood-spotify/";
    const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
    const RESPONSE_TYPE = "token";
    const SCOPES = [
      "playlist-read-private",
      "playlist-read-collaborative"
    ];

    // ====== æŠ“ DOM å…ƒä»¶ ======
    const loginBtn = document.getElementById("loginBtn");
    const statusSpan = document.getElementById("spotifyStatus");
    const form = document.getElementById("moodForm");
    const energyInput = document.getElementById("energy");
    const energyValueSpan = document.getElementById("energyValue");
    const errorBox = document.getElementById("errorBox");
    const playlistsSection = document.getElementById("playlistsSection");
    const playlistsContainer = document.getElementById("playlistsContainer");

    // å„²å­˜ token
    let accessToken = null;
    let tokenExpiresAt = null;

    function setError(message) {
      errorBox.textContent = message || "";
    }

    // ====== è§£æ URL hash æ‹¿ access_token ======
    function handleRedirectFromSpotify() {
      if (window.location.hash) {
        const hash = window.location.hash.substring(1); // å»é™¤ "#"
        const params = new URLSearchParams(hash);
        const token = params.get("access_token");
        const expiresIn = params.get("expires_in");

        if (token) {
          accessToken = token;
          const now = Date.now();
          tokenExpiresAt = now + Number(expiresIn || 3600) * 1000;

          // å­˜åœ¨ localStorageï¼Œé‡æ•´ä¸æœƒæ¶ˆå¤±
          localStorage.setItem("spotify_access_token", accessToken);
          localStorage.setItem("spotify_token_expires_at", String(tokenExpiresAt));

          // æ¸…é™¤ç¶²å€ä¸Šçš„ hashï¼ˆæ¯”è¼ƒä¹¾æ·¨ï¼‰
          window.history.replaceState({}, document.title, REDIRECT_URI);
        }
      } else {
        // å˜—è©¦å¾ localStorage æ‹¿èˆŠ token
        const storedToken = localStorage.getItem("spotify_access_token");
        const storedExpiresAt = localStorage.getItem("spotify_token_expires_at");
        if (storedToken && storedExpiresAt && Date.now() < Number(storedExpiresAt)) {
          accessToken = storedToken;
          tokenExpiresAt = Number(storedExpiresAt);
        }
      }

      if (accessToken) {
        statusSpan.textContent = "å·²ç™»å…¥ Spotify";
        loginBtn.textContent = "é‡æ–°ç™»å…¥";
      } else {
        statusSpan.textContent = "å°šæœªç™»å…¥";
        loginBtn.textContent = "Login with Spotify";
      }
    }

    // ====== Login æŒ‰éˆ•äº‹ä»¶ï¼šå°å» Spotify æˆæ¬Š ======
    loginBtn.addEventListener("click", function () {
      setError("");

      const authUrl =
        AUTH_ENDPOINT +
        "?client_id=" +
        encodeURIComponent(CLIENT_ID) +
        "&redirect_uri=" +
        encodeURIComponent(REDIRECT_URI) +
        "&response_type=" +
        encodeURIComponent(RESPONSE_TYPE) +
        "&scope=" +
        encodeURIComponent(SCOPES.join(" "));

      console.log("Auth URL:", authUrl);
      window.location.href = authUrl;
    });

    // èƒ½é‡æ»‘æ¡¿é¡¯ç¤ºæ•¸å­—
    energyInput.addEventListener("input", function () {
      energyValueSpan.textContent = energyInput.value;
    });

    // æŠŠé¸é …çµ„åˆæˆæœå°‹å­—ä¸²
    function buildSearchQuery(selection) {
      const { mood, styles, scene, energy } = selection;

      const moodMap = {
        "é–‹å¿ƒ": "happy",
        "æ”¾ç©º": "chill relax",
        "å¾ˆç´¯": "tired calm",
        "æƒ³å“­": "sad emotional",
        "æƒ³è¡åˆºè®€æ›¸": "focus study motivation",
        "æƒ³é‹å‹•": "workout gym",
        "æƒ³è€å»¢": "lazy chill"
      };

      const sceneMap = {
        "è®€æ›¸": "study",
        "å·¥ä½œ": "work focus",
        "é€šå‹¤": "commute",
        "ç¡å‰": "sleep",
        "é‹å‹•": "running gym",
        "å¤±æˆ€": "heartbreak"
      };

      let energyWords = "";
      if (energy <= 30) {
        energyWords = "low energy soft";
      } else if (energy <= 70) {
        energyWords = "medium energy";
      } else {
        energyWords = "high energy";
      }

      const moodWords = moodMap[mood] || "";
      const sceneWords = sceneMap[scene] || "";
      const stylesWords = styles.length > 0 ? styles.join(" ") : "playlist";

      return [stylesWords, moodWords, sceneWords, energyWords]
        .filter(Boolean)
        .join(" ")
        .trim();
    }

    // å‘¼å« Spotify æœå°‹ API
    async function searchPlaylists(query) {
      if (!accessToken) {
        throw new Error("å°šæœªç™»å…¥ Spotifyï¼Œè«‹å…ˆæŒ‰å³ä¸Šè§’ Login");
      }
      const url =
        "https://api.spotify.com/v1/search?type=playlist&limit=6&q=" +
        encodeURIComponent(query);

      const res = await fetch(url, {
        headers: {
          Authorization: "Bearer " + accessToken
        }
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("Spotify API error:", res.status, text);
        throw new Error("Spotify API éŒ¯èª¤ï¼š" + res.status);
      }

      const data = await res.json();
      return data.playlists.items || [];
    }

    function renderPlaylists(playlists) {
      playlistsContainer.innerHTML = "";
      if (!playlists.length) {
        playlistsSection.style.display = "none";
        setError("æ‰¾ä¸åˆ°ç¬¦åˆçš„æ­Œå–®ï¼Œæ›å€‹çµ„åˆå†è©¦è©¦çœ‹ã€‚");
        return;
      }
      playlistsSection.style.display = "block";
      playlists.forEach((pl) => {
        const card = document.createElement("div");
        card.className = "playlist-card";

        const img = document.createElement("img");
        img.src =
          pl.images && pl.images.length
            ? pl.images[0].url
            : "https://via.placeholder.com/64?text=â™ª";
        img.alt = pl.name;

        const body = document.createElement("div");
        body.className = "playlist-body";

        const nameEl = document.createElement("div");
        nameEl.className = "playlist-name";
        nameEl.textContent = pl.name;

        const ownerEl = document.createElement("div");
        ownerEl.className = "playlist-owner";
        ownerEl.textContent = "by " + (pl.owner && pl.owner.display_name ? pl.owner.display_name : "Unknown");

        const linkWrapper = document.createElement("div");
        linkWrapper.className = "playlist-link";
        const link = document.createElement("a");
        link.href = pl.external_urls.spotify;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = "åœ¨ Spotify é–‹å•Ÿ";
        linkWrapper.appendChild(link);

        body.appendChild(nameEl);
        body.appendChild(ownerEl);
        body.appendChild(linkWrapper);

        card.appendChild(img);
        card.appendChild(body);
        playlistsContainer.appendChild(card);
      });
    }

    // è¡¨å–®é€å‡ºï¼šçµ„ query â†’ call API
    form.addEventListener("submit", async function (event) {
      event.preventDefault();
      setError("");

      const mood = document.getElementById("mood").value;
      const scene = document.getElementById("scene").value;
      const energy = parseInt(document.getElementById("energy").value, 10);
      const styles = Array.from(
        document.querySelectorAll('input[name="styles"]:checked')
      ).map((input) => input.value);

      const selection = { mood, styles, scene, energy };
      console.log("ä½¿ç”¨è€…é¸æ“‡ï¼š", selection);

      const query = buildSearchQuery(selection);
      console.log("æœå°‹é—œéµå­—ï¼š", query);

      try {
        const playlists = await searchPlaylists(query);
        renderPlaylists(playlists);
      } catch (err) {
        console.error(err);
        setError(err.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œç­‰ç­‰å†è©¦ä¸€æ¬¡ã€‚");
      }
    });

    // åˆå§‹åŒ–ï¼šè™•ç† redirect & æ›´æ–°ç™»å…¥ç‹€æ…‹
    handleRedirectFromSpotify();
  </script>
</body>
</html>
